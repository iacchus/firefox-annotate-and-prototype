var global="undefined"!=typeof chrome?chrome:"undefined"!=typeof browser?browser:void 0,NP={init:function(){global.browserAction.onClicked.addListener(this.inject),global.runtime.onMessage.addListener(function(a,b,c){if("take_screen_shot"===a.method)NP.screenShot(c);else if("get_pixel_color"===a.method){var d=a.point;NP.getPixelColor(d,c)}else"save_data"===a.method?NP.saveData(a.config):"get_data"===a.method&&NP.getData(c);return!0})},getPixelColor:function(a,b){global.tabs.captureVisibleTab(null,null,function(c){var d=document.createElement("canvas"),e=d.getContext("2d"),f=new Image;document.documentElement.appendChild(d),f.src=c,f.onload=function(){d.width=f.naturalWidth,d.height=f.naturalHeight,e.drawImage(f,0,0);var c=e.getImageData(0,0,d.width,d.height),g=4*(a.y*c.width+a.x),h=c.data;if("function"==typeof b){var i={r:h[g],g:h[g+1],b:h[g+2],a:h[g+3]};document.documentElement.removeChild(d),b(i)}}})},saveData:function(a){try{localStorage.setItem("config",JSON.stringify(a))}catch(b){}},getData:function(a){var b=localStorage.getItem("config"),c=null;try{c=JSON.parse(b)}catch(d){}a(c)},inject:function(){global.tabs.insertCSS(null,{file:"/css/main.min.css"},function(){if(global.extension.lastError){global.extension.lastError.message;try{alert("We are sorry, but the page you are viewing is not supported. Please try another page.")}catch(a){}}global.tabs.executeScript(null,{file:"/js/inject.js"})})},screenShot:function(a){global.tabs.captureVisibleTab(function(b){var c=global.extension.getURL("screen.html");global.tabs.query({},function(d){var e;if(d&&d.length)for(var f=d.length-1;f>=0;f--)if(d[f].url===c){e=d[f];break}e?global.tabs.update(e.id,{active:!0},Function.prototype.bind.call(NP.updateScreenshot,NP,b,a,0)):global.tabs.create({url:c},Function.prototype.bind.call(NP.updateScreenshot,NP,b,a,0))})})},updateScreenshot:function(a,b){var c=arguments[2];"undefined"!=typeof c&&null!==c||(c=0),c>10||global.runtime.sendMessage({method:"update_url",url:a},function(d){d&&d.success||window.setTimeout(Function.prototype.bind.call(NP.updateScreenshot,NP,a,b,++c),300)})}};NP.init();